  ---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import Link from '@/components/Link.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import { getAllPosts, groupPostsByYear } from '@/lib/data-utils'
import { formatDate } from '@/lib/utils'

const allPosts = await getAllPosts()
const postsByYear = groupPostsByYear(allPosts)
const years = Object.keys(postsByYear).sort((a, b) => parseInt(b) - parseInt(a))
---

<Layout class="max-w-3xl">
  <PageHead slot="head" title="Archives" />
  <Breadcrumbs items={[{ label: 'Archives', icon: 'lucide:archive' }]} />

  <section class="flex flex-col gap-y-8">
    <div class="flex flex-col gap-y-2">
      <h1 class="text-3xl font-medium">Archives</h1>
      <p class="text-muted-foreground text-sm">
        A complete timeline of all {allPosts.length} posts, organized by year.
      </p>
    </div>

    {
      years.map((year) => (
        <div class="flex flex-col gap-y-4">
          <div class="flex items-center gap-x-4">
            <h2 class="text-2xl font-semibold">{year}</h2>
            <div class="bg-border h-px flex-1" />
            <span class="text-muted-foreground text-sm">
              {postsByYear[year].length} post{postsByYear[year].length === 1 ? '' : 's'}
            </span>
          </div>

          <div class="border-l-2 border-border ml-4 flex flex-col gap-y-3 pl-6">
            {postsByYear[year].map((post) => (
              <div class="group relative">
                <div class="bg-border absolute -left-[1.6rem] top-1.5 h-3 w-3 rounded-full ring-4 ring-background transition-colors group-hover:bg-foreground" />
                <Link
                  href={`/${post.collection}/${post.id}`}
                  class="flex flex-col gap-y-1"
                >
                  <div class="flex flex-wrap items-baseline gap-x-3 gap-y-1">
                    <h3 class="font-medium transition-colors group-hover:text-primary">
                      {post.data.title}
                    </h3>
                    <span class="text-muted-foreground text-xs">
                      {formatDate(post.data.date)}
                    </span>
                  </div>
                  <p class="text-muted-foreground text-sm">
                    {post.data.description}
                  </p>
                </Link>
              </div>
            ))}
          </div>
        </div>
      ))
    }
  </section>
</Layout>
